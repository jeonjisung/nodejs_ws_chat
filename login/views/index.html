<!DOCTYPE html>
<html>

<head lang="ko">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Chatting</title>
    <style type="text/css">
        #screen1 {
            width: 50%;
            height: 50%;
            background-color: white;
        }

        #screen2 {
            width: 50%;
            height: 50%;
            float: right;
            background-color: white;
        }
    </style>
</head>

{% if isLogin %}

<body>
    <h1>Chat</h1>
    <div id="screen1">
        {{userid}}님 환영합니다. <br />
        <a href="/user/logout">로그아웃 </a>
        <a href="/user/info">회원 정보</a>
        <div>
            <input type="text" id="user_id" style="width: 100px" value="{{userid}}" readonly />
            <input type="text" id="user_message" placeholder="메시지" style="width: 200px" />
            <button onClick="sendMessage()">전송</button>
        </div>
        <div id="chat-log">
        </div>
    </div>
    <div id="screen2">
        <canvas id="myChart" width="400" height="300"></canvas>
        <button id="sendAjax">button</button>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.js"></script>
        <script>
            var data = {
                labels: [],
                datasets: [
                    {
                        label: '채팅 기록',
                        data: [
                            0, 0, 0, 0
                        ],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255,99,132,1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }
                ]
            };

            var options = {
                animation: {
                    animateScale: true
                },
                responsive: false,
                scales: {
                    yAxes: [
                        {
                            ticks: {
                                beginAtZero: true
                            }
                        }
                    ]
                }
            };

            var ctx = document.getElementById("myChart").getContext('2d');
            var myBarChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: options
            });

            var button = document.getElementById("sendAjax")

            button.addEventListener("click", function () {
                sendAjax('http://localhost:3000/');
            })

            function sendAjax(url) {
                var oReq = new XMLHttpRequest();

                oReq.open('POST', url);
                oReq.setRequestHeader('Content-Type', "application/json") // json 형태로 보낸다
                oReq.send();

                oReq.addEventListener('load', function () {
                    var result = JSON.parse(oReq.responseText);
                    var chat = result.chat;
                    var comp_chat = data.datasets[0].data;
                    var date = result.date;
                    var comp_label = data.labels;

                    for (var i = 0; i < comp_chat.length; i++) {
                        comp_chat[i] = chat[i];
                        comp_label[i] = date[i];
                    }

                    data.datasets[0].data = comp_chat;
                    myBarChart.update();
                })
            }
        </script>
    </div>
</body>

</html>
{% else %}

<a href="/user/login">로그인</a>
<a href="/user/join">회원가입</a>

{% endif %}

<link rel="stylesheet" href="https://cdn.datatables.net/t/bs-3.3.6/jqc-1.12.0,dt-1.10.11/datatables.min.css" />
<script src="https://cdn.datatables.net/t/bs-3.3.6/jqc-1.12.0,dt-1.10.11/datatables.min.js"></script>
<script type="text/javascript">
    const ws = new WebSocket("ws://localhost:3000")

    function clearMessage() {
        document.getElementById("user_message").value = ""
    }

    function sendMessage() {
        const username = document.getElementById("user_id").value
        const message = document.getElementById("user_message").value

        var send_data_obj = new Object();

        send_data_obj.username = username;
        send_data_obj.message = message;

        var send_data_str = JSON.stringify(send_data_obj);
        console.log(send_data_str);
        ws.send(send_data_str)
        clearMessage()
    }

    function receiveMessage(event) {
        const chat = document.createElement("div")
        const message = document.createTextNode(event.data)
        chat.appendChild(message)

        const chatLog = document.getElementById("chat-log")
        chatLog.appendChild(chat)
    }

    ws.onmessage = receiveMessage

</script>